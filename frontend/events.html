<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoos Who Poop - Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        .spinner { border: 4px solid rgba(0,0,0,.1); border-left-color:#3b82f6; border-radius:50%; width:24px; height:24px; animation: spin 1s linear infinite;}
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback } = React;

// CHANGE IF ON LOCAL HOST
//const API_BASE_URL = 'http://localhost/HoosWhoPoop/backend/';
const API_BASE_URL = 'https://www.cs.virginia.edu/~kng4jc/HoosWhoPoop/backend/auth/login-api.php'

const GOAL_API_URL = `${API_BASE_URL}/goal-api.php`;
const EVENT_API_URL = `${API_BASE_URL}/event-api.php`;
const CHECK_SESSION_API_URL = `${API_BASE_URL}/auth/check-session-api.php`;
const LOGOUT_API_URL = `${API_BASE_URL}/auth/logout-api.php`;

const LoadingSpinner = () => (
    <div className="flex justify-center items-center h-24"><div className="spinner"></div></div>
);

const ErrorMessage = ({ message, onClear }) => (
    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
        <strong className="font-bold">Error: </strong>
        <span className="block sm:inline">{message}</span>
        <span className="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onClick={onClear}>âœ–</span>
    </div>
);

function App() {
    const [user, setUser] = useState(null);
    const [isCheckingAuth, setIsCheckingAuth] = useState(true);
    const [goals, setGoals] = useState([]);
    const [events, setEvents] = useState([]);
    const [loading, setLoading] = useState({ goals: true, events: true });
    const [error, setError] = useState(null);

    useEffect(() => {
        const checkAuth = async () => {
            try {
                const response = await fetch(CHECK_SESSION_API_URL, { credentials:'include' });
                if(!response.ok) throw new Error('Not logged in');
                const data = await response.json();
                if(data.status==='success') setUser(data.user);
                else throw new Error('Not logged in');
            } catch(e){ window.location.href='login.html'; }
            finally { setIsCheckingAuth(false); }
        };
        checkAuth();
    }, []);

    const fetchData = useCallback(async (url, key, setter)=>{
        setLoading(prev => ({...prev,[key]:true}));
        try{
            const response = await fetch(url);
            if(!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();
            setter(data);
        }catch(e){
            setError(`Could not fetch ${key}: ${e.message}`);
        }finally{
            setLoading(prev => ({...prev,[key]:false}));
        }
    }, []);

    useEffect(()=>{
        if(user){
            fetchData(GOAL_API_URL,'goals',setGoals);
            fetchData(EVENT_API_URL,'events',setEvents);
        }
    },[user,fetchData]);

    const handleEventAdded = ()=>fetchData(EVENT_API_URL,'events',setEvents);

    const handleLogout = async ()=>{
        try{ await fetch(LOGOUT_API_URL,{method:'POST',credentials:'include'}); }
        finally{ window.location.href='login.html'; }
    };

    if(isCheckingAuth) return <div className="flex items-center justify-center min-h-screen"><LoadingSpinner/></div>;

    return (
        <div className="container mx-auto p-4 max-w-4xl">
            <header className="text-center mb-8">
                <h1 className="text-4xl font-bold text-blue-600">HoosWhoPoop - Events</h1>
                <div className="flex justify-between items-center mt-2">
                    <span/>
                    <p className="text-lg text-gray-700 mt-2">
                        Hello pooper, <span className="font-mono bg-blue-100 px-2 py-1 rounded">{user.username}</span>
                    </p>
                    <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition text-sm">Logout</button>
                </div>
            </header>

            {error && <ErrorMessage message={error} onClear={()=>setError(null)} />}

            <div className="space-y-8">
                <EventManager goals={goals} events={events} loading={loading.events} onEventAdded={handleEventAdded} setError={setError}/>
            </div>
        </div>
    );
}

// --- EventManager ---
function EventManager({goals,events,loading,onEventAdded,setError}){
    const [selectedGoal,setSelectedGoal] = useState('');
    const [day,setDay] = useState('');
    const [startTime,setStartTime] = useState('');
    const [endTime,setEndTime] = useState('');

    const handleSubmit = async e => {
        e.preventDefault();
        if(!selectedGoal || !day || !startTime || !endTime){ setError("Please fill out all event fields."); return;}
        try{
            const res = await fetch(EVENT_API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({goal_id:parseInt(selectedGoal),day,start_time:startTime,end_time:endTime})});
            const data = await res.json();
            if(!res.ok || data.status==='error') throw new Error(data.message||'Failed to add event.');
            onEventAdded();
            setSelectedGoal(''); setDay(''); setStartTime(''); setEndTime('');
        }catch(e){ setError(`Failed to add event: ${e.message}`);}
    };

    return (
        <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-2xl font-semibold mb-4 text-gray-800">Track Events</h2>
            <form onSubmit={handleSubmit} className="space-y-4 mb-4">
                <select value={selectedGoal} onChange={e=>setSelectedGoal(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Select a goal to log time for...</option>
                    {goals.map(g=><option key={g.goal_id} value={g.goal_id}>{g.category} (by {g.deadline})</option>)}
                </select>
                <input type="date" value={day} onChange={e=>setDay(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md"/>
                <div className="flex space-x-2">
                    <input type="time" value={startTime} onChange={e=>setStartTime(e.target.value)} className="w-1/2 p-2 border border-gray-300 rounded-md"/>
                    <input type="time" value={endTime} onChange={e=>setEndTime(e.target.value)} className="w-1/2 p-2 border border-gray-300 rounded-md"/>
                </div>
                <button type="submit" className="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">Add Event</button>
            </form>

            <h3 className="text-lg font-medium mb-2">Existing Events:</h3>
            {loading ? <LoadingSpinner/> : (
                <ul className="list-disc list-inside h-64 overflow-y-auto bg-gray-50 p-2 rounded-md">
                    {events.map(ev=>(
                        <li key={ev.event_id} className="text-gray-700">
                            {ev.category}: {ev.day} from {ev.start_time} to {ev.end_time}
                        </li>
                    ))}
                </ul>
            )}
        </section>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
