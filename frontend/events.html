<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoos Who Poop</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!--extracted navbar-->
    <script src="navBar.js"></script>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback } = React;

const API_BASE_URL = 'http://localhost/HoosWhoPoop/backend/';
// const API_BASE_URL = 'https://www.cs.virginia.edu/~kng4jc/HoosWhoPoop/backend/';
const GOAL_API_URL = `${API_BASE_URL}/goal-api.php`;
const EVENT_API_URL = `${API_BASE_URL}/event-api.php`;
const EVENT_FILTER_URL = `${API_BASE_URL}/event-filter.php`;
const CHECK_SESSION_API_URL = `${API_BASE_URL}/auth/check-session-api.php`;
const LOGOUT_API_URL = `${API_BASE_URL}/auth/logout-api.php`;

const LoadingSpinner = () => (
    <div className="flex justify-center items-center h-24"><div className="spinner"></div></div>
);

// const ErrorMessage = ({ message, onClear }) => (
//     <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
//         <strong className="font-bold">Error: </strong>
//         <span className="block sm:inline">{message}</span>
//         <span className="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onClick={onClear}>✖</span>
//     </div>
// );
//use {error && <ErrorMessage message={error} onClear={()=>setError(null)} />} to display

function App() {
    const [user, setUser] = useState(null);
    const [isCheckingAuth, setIsCheckingAuth] = useState(true);
    const [goals, setGoals] = useState([]);
    const [events, setEvents] = useState([]);
    const [loading, setLoading] = useState({ goals: true, events: true });
    const [error, setError] = useState(null);

    useEffect(() => {
        const checkAuth = async () => {
            try {
                const response = await fetch(CHECK_SESSION_API_URL, { credentials:'include' });
                if(!response.ok) throw new Error('Not logged in');
                const data = await response.json();
                if(data.status==='success') setUser(data.user);
                else throw new Error('Not logged in');
            } catch(e){ window.location.href='login.html'; }
            finally { setIsCheckingAuth(false); }
        };
        checkAuth();
    }, []);

    const fetchData = useCallback(async (url, key, setter)=>{
        setLoading(prev => ({...prev,[key]:true}));
        try{
            const response = await fetch(url);
            if(!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();
            setter(data);
        }catch(e){
            setError(`Could not fetch ${key}: ${e.message}`);
        }finally{
            setLoading(prev => ({...prev,[key]:false}));
        }
    }, []);

    useEffect(()=>{
        if(user){
            fetchData(GOAL_API_URL,'goals',setGoals);
            fetchData(EVENT_API_URL,'events',setEvents);
        }
    },[user,fetchData]);

    const handleEventAdded = ()=>fetchData(EVENT_API_URL,'events',setEvents);

    const handleLogout = async ()=>{
        try{ await fetch(LOGOUT_API_URL,{method:'POST',credentials:'include'}); }
        finally{ window.location.href='login.html'; }
    };

    if(isCheckingAuth) return <div className="flex items-center justify-center min-h-screen"><LoadingSpinner/></div>;

    return (
        <div className="">
            {NavBar({user, handleLogout})}

            <div className="content-container">
                <div className="main-columns">
                    <div className="two-columns">
                        <EventAdder goals={goals} events={events} loading={loading.events} onEventAdded={handleEventAdded} setError={setError}/>
                    </div>
                    <div className="two-columns">
                        <EventDisplay goals={goals} events={events} setEvents={setEvents} loading={loading.events}/>
                    </div>
                </div>
            </div>
        </div>
    );
}

// --- EventManager ---
function EventAdder({goals,events,loading,onEventAdded,setError}){
    const [selectedGoal,setSelectedGoal] = useState('');
    const [day,setDay] = useState('');
    const [startTime,setStartTime] = useState('');
    const [endTime,setEndTime] = useState('');

    const handleSubmit = async e => {
        e.preventDefault();
        if(!selectedGoal || !day || !startTime || !endTime){ setError("Please fill out all event fields."); return;}
        try{
            const res = await fetch(EVENT_API_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({action: "post_events", goal_id:parseInt(selectedGoal), day, start_time:startTime, end_time:endTime})});
            const data = await res.json();
            if(!res.ok || data.status==='error') throw new Error(data.message||'Failed to add event.');
            onEventAdded();
            setSelectedGoal(''); setDay(''); setStartTime(''); setEndTime('');
        }catch(e){ setError(`Failed to add event: ${e.message}`);}
    };

    return (
        <section>
            <h2 >Track Events</h2>
            <form onSubmit={handleSubmit} className="poo-form">
                <select value={selectedGoal} onChange={e=>setSelectedGoal(e.target.value)} className="poo-select">
                    <option value="">Select a goal to log time for...</option>
                    {goals.map(g=><option key={g.goal_id} value={g.goal_id}>{g.category} (by {g.deadline})</option>)}
                </select>
                <input type="date" value={day} onChange={e=>setDay(e.target.value)} className="poo-input"/>
                <div className="flex space-x-2">
                    <input type="time" value={startTime} onChange={e=>setStartTime(e.target.value)} className="poo-input"/>
                    <input type="time" value={endTime} onChange={e=>setEndTime(e.target.value)} className="poo-input"/>
                </div>
                <button type="submit" className="add-button">Add Event</button>
            </form>
        </section>
    );
}

function EventDisplay({ goals, events, setEvents, loading }) {
    const [selectedGoal, setSelectedGoal] = useState('');
    const [selectedDate, setSelectedDate] = useState('');

    const handleFilter = async (e) => {
        e.preventDefault();
        console.log("Filter clicked!");

        try {
            const response = await fetch(EVENT_FILTER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "filter_events",
                    goal_id: selectedGoal ? parseInt(selectedGoal) : null,
                    day: selectedDate || null
                })
            });

            const result = await response.json();
            if (!response.ok || result.status === "error") {
                throw new Error(result.message || "Failed to filter events");
            }

            // ✅ Correctly update events
            setEvents(result.events);

        } catch (e) {
            console.error("Filter error:", e);
        }
    };

    return (
        <section>
            <h2>Existing Events:</h2>

            <form onSubmit={handleFilter} className="poo-form">
                <select value={selectedGoal} onChange={e => setSelectedGoal(e.target.value)} className="poo-select">
                    <option value="">Filter by goal...</option>
                    {goals.map(g => (
                        <option key={g.goal_id} value={g.goal_id}>
                            {g.category} (by {g.deadline})
                        </option>
                    ))}
                </select>

                <input type="date"
                       value={selectedDate}
                       onChange={e => setSelectedDate(e.target.value)}
                       className="poo-input"
                />

                <button type="submit" className="add-button">Filter</button>
            </form>

            {loading ? <LoadingSpinner/> : (
                <ul>
                    {events.map(ev => (
                        <li key={ev.event_id} className="poo-item">
                            {ev.category}: {ev.day} from {ev.start_time} to {ev.end_time}
                            <span className="list-actions">
                                <button onClick={() => handleEdit(ev.event_id)} className="icon-button edit-item">
                                    <i className="fa-solid fa-pen"></i>
                                </button>
                                <button onClick={() => handleDelete(ev.event_id)} className="icon-button delete-item">
                                    <i className="fa-solid fa-trash"></i>
                                </button>
                            </span>
                        </li>
                    ))}
                </ul>
            )}
        </section>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
