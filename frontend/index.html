<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoos Who Poop</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!--extracted navbar-->
    <script src="navBar.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- API URLs --- 
        // CHANGE B/W LOCAL AND UVA SERVER
        const API_BASE_URL = 'http://localhost/HoosWhoPoop/backend/';
        //const API_BASE_URL = 'https://www.cs.virginia.edu/~kng4jc/HoosWhoPoop/backend/';

        const HABIT_API_URL = `${API_BASE_URL}/habit-api.php`;
        const GOAL_API_URL = `${API_BASE_URL}/goal-api.php`;
        const FRIEND_API_URL = `${API_BASE_URL}/friends-api.php`;
        const CHECK_SESSION_API_URL = `${API_BASE_URL}/auth/check-session-api.php`;
        const LOGOUT_API_URL = `${API_BASE_URL}/auth/logout-api.php`;

        // --- Components ---
        const LoadingSpinner = () => <div className="spinner"></div>;

        const ErrorMessage = ({ message, onClear }) => (
            <div className="error-message">
                <strong>Error: </strong>
                <span>{message}</span>
                <span className="close" onClick={onClear}>✖</span>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [isCheckingAuth, setIsCheckingAuth] = useState(true);
            const [habits, setHabits] = useState([]);
            const [goals, setGoals] = useState([]);
            const [friends, setFriends] = useState([]);
            const [loading, setLoading] = useState({ habits: true, goals: true, friends: true });
            const [error, setError] = useState(null);

            useEffect(() => {
                const checkAuth = async () => {
                    try {
                        const response = await fetch(CHECK_SESSION_API_URL, { credentials: 'include' });
                        if (!response.ok) throw new Error('Not logged in');
                        const data = await response.json();
                        if (data.status === 'success') setUser(data.user);
                        else throw new Error('Not logged in');
                    } catch (e) {
                        window.location.href = 'login.html';
                    } finally { setIsCheckingAuth(false); }
                };
                checkAuth();
            }, []);

            const fetchData = useCallback(async (url, key, setter) => {
                setLoading(prev => ({ ...prev, [key]: true }));
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                    const data = await response.json();
                    setter(data);
                } catch (e) {
                    setError(`Could not fetch ${key}: ${e.message}`);
                } finally {
                    setLoading(prev => ({ ...prev, [key]: false }));
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchData(HABIT_API_URL, 'habits', setHabits);
                    fetchData(GOAL_API_URL, 'goals', setGoals);
                    fetchData(FRIEND_API_URL, 'friends', setFriends);
                }
            }, [user, fetchData]);

            const handleLogout = async () => {
                try { await fetch(LOGOUT_API_URL, { method: 'POST', credentials: 'include' }); }
                finally { window.location.href = 'login.html'; }
            };

            if (isCheckingAuth) return <LoadingSpinner />;

            return (
                <div>
                    {NavBar({user, handleLogout})}

                    {error && <ErrorMessage message={error} onClear={() => setError(null)} />}

                    <div className="content-container">
                        <div className="main-columns">
                            <div className="three-columns">
                                <HabitManager habits={habits} loading={loading.habits} setHabits={setHabits}/>
                            </div>

                            <div className="three-columns">
                                <GoalManager goals={goals} habits={habits} loading={loading.goals} setGoals={setGoals}/>
                            </div>

                            {/* Right column: Goal on top, Friends directly below (matching font/size) */}
                            <div className="three-columns">
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                    <img src="../media/neutral_poo.PNG" alt="neutral-poo" className="poo"/>
                                    {/* Use same section styles as other lists and inherit font/size */}
                                    <div style={{ width: '100%' }}>
                                        <FriendManager friends={friends} loading={loading.friends} setFriends={setFriends} />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function NavBar({user, handleLogout}) {
            return (
                <header className="app-header">
                    <h1>HoosWhoPoop</h1>
                    <p>Hello pooper, <span className="username">{user.username}</span></p>
                    <ul className="navigation">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="events.html">Entries</a></li>
                        <li><a href="rooms.html">Rooms</a></li>
                    </ul>
                    <button className="logout-button" onClick={handleLogout}>Logout</button>
                </header>
            )
        }

        function HabitItem({ habit, onDelete, onEdit }) {
            const [isEditing, setIsEditing] = React.useState(false);
            const [editValue, setEditValue] = React.useState(habit.category);

            const handleSave = async () => {
                if (!editValue.trim()) return;
                const success = await onEdit(habit.habit_id, editValue);
                if (success) setIsEditing(false);
            };

            const handleCancel = () => {
                setIsEditing(false);
                setEditValue(habit.category);
            };

            return (
                <li className="poo-item">
                    {isEditing ? (
                        <React.Fragment>
                            <input
                                className="poo-input"
                                value={editValue}
                                onChange={e => setEditValue(e.target.value)}
                                autoFocus
                            />
                            <button onClick={handleSave} className="icon-button">✔</button>
                            <button onClick={handleCancel} className="icon-button">✖</button>
                        </React.Fragment>
                    ) : (
                        <React.Fragment>
                            <span className="habit-text">{habit.category}</span>
                            <span className="list-actions">
                                <i
                                    className="fa-solid fa-pen edit-icon"
                                    onClick={() => setIsEditing(true)}
                                ></i>
                                <i
                                    className="fa-solid fa-trash delete-icon"
                                    onClick={() => onDelete(habit.habit_id)}
                                ></i>
                            </span>
                        </React.Fragment>
                    )}
                </li>
            );
        }

        function HabitManager({ habits, loading, setHabits }) {
            const handleDelete = async (habitId) => {
                try {
                    const res = await fetch(HABIT_API_URL, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ habit_id: habitId })
                    });
                    const result = await res.json();
                    if (result.status !== 'success') throw new Error(result.message);

                    setHabits(prev => prev.filter(h => h.habit_id !== habitId));
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            };

            const handleEdit = async (habitId, newCategory) => {
                try {
                    const res = await fetch(HABIT_API_URL, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ habit_id: habitId, category: newCategory })
                    });
                    const result = await res.json();
                    if (result.status !== 'success') throw new Error(result.message);

                    setHabits(prev =>
                        prev.map(h => h.habit_id === habitId ? { ...h, category: newCategory } : h)
                    );
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            };

            const [newHabit, setNewHabit] = React.useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newHabit.trim()) return;
                try {
                    const response = await fetch(HABIT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: newHabit })
                    });
                    const result = await response.json();
                    if (!response.ok || result.status === 'error') throw new Error(result.message || 'Failed to add habit');

                    setNewHabit('');
                    setHabits(prev => [result.habit, ...prev]); // Add new habit at top
                } catch (e) {
                    console.error(e);
                }
            };

            return (
                <section className="habit-section">
                    <h2>Habits</h2>
                    <form onSubmit={handleSubmit} className="poo-form">
                        <input
                            value={newHabit}
                            onChange={e => setNewHabit(e.target.value)}
                            placeholder="Add new habit"
                            className="poo-input"
                        />
                        <button type="submit" className="add-button">Add Habit</button>
                    </form>

                    {loading ? <div className="spinner"></div> :
                        <ul className="list">
                            {habits.map(h => (
                                <HabitItem
                                    key={h.habit_id}
                                    habit={h}
                                    onDelete={handleDelete}
                                    onEdit={handleEdit}
                                />
                            ))}
                        </ul>
                    }
                </section>
            );
        }

        function GoalItem({ goal, habits, onDelete, onEdit }) {
            const [isEditing, setIsEditing] = React.useState(false);

            const [editHabit, setEditHabit] = React.useState(goal.habit_id);
            const [editDeadline, setEditDeadline] = React.useState(goal.deadline);
            const [editTime, setEditTime] = React.useState(goal.goal_time);

            const handleSave = async () => {
                if (!editHabit || !editDeadline || !editTime) return;

                const success = await onEdit(
                    goal.goal_id,
                    parseInt(editHabit),
                    editDeadline,
                    parseInt(editTime)
                );

                if (success) setIsEditing(false);
            };

            const handleCancel = () => {
                setIsEditing(false);
                setEditHabit(goal.habit_id);
                setEditDeadline(goal.deadline);
                setEditTime(goal.goal_time);
            };

            const getHabitName = (id) => {
                if (!habits || habits.length === 0) return "Loading...";
                const numericId = parseInt(id);
                const habit = habits.find(h => parseInt(h.habit_id) === numericId);
                return habit ? habit.category : "Unknown";
            };

            const [selectedHabit, setSelectedHabit] = useState('');
            const [deadline, setDeadline] = useState('');
            const [goalTime, setGoalTime] = useState('');

            return (
                <li className="poo-item">
                    {isEditing ? (
                        <React.Fragment>
                            <select
                                className="poo-select"
                                value={editHabit}
                                onChange={(e) => setEditHabit(e.target.value)}
                            >
                                {habits.map((h) => (
                                    <option key={h.habit_id} value={h.habit_id}>
                                        {h.category}
                                    </option>
                                ))}
                            </select>

                            <input
                                type="date"
                                className="poo-input"
                                value={editDeadline}
                                onChange={(e) => setEditDeadline(e.target.value)}
                            />

                            <input
                                type="number"
                                className="poo-input"
                                value={editTime}
                                onChange={(e) => setEditTime(e.target.value)}
                            />

                            <button onClick={handleSave} className="icon-button">✔</button>
                            <button onClick={handleCancel} className="icon-button">✖</button>
                        </React.Fragment>
                    ) : (
                        <React.Fragment>
                            <span className="goal-text">
                                {getHabitName(goal.habit_id)} — {goal.goal_time} hrs by {goal.deadline}
                            </span>

                            <span className="list-actions">
                                <i
                                    className="fa-solid fa-pen edit-icon"
                                    onClick={() => setIsEditing(true)}
                                ></i>
                                <i
                                    className="fa-solid fa-trash delete-icon"
                                    onClick={() => onDelete(goal.goal_id)}
                                ></i>
                            </span>
                        </React.Fragment>
                    )}
                </li>
            );
        }

        function GoalManager({ goals, habits, loading, setGoals }) {
            const [selectedHabit, setSelectedHabit] = React.useState("");
            const [deadline, setDeadline] = React.useState("");
            const [goalTime, setGoalTime] = React.useState("");

            // ADD GOAL
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedHabit || !deadline || !goalTime) return;

                try {
                    const res = await fetch(GOAL_API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            habit_id: parseInt(selectedHabit),
                            deadline,
                            goal_time: parseInt(goalTime)
                        }),
                    });

                    const result = await res.json();
                    if (!res.ok || result.status === "error")
                        throw new Error(result.message);

                    setGoals((prev) => [result.goal, ...prev]);

                    setSelectedHabit("");
                    setDeadline("");
                    setGoalTime("");
                } catch (e) {
                    console.error(e);
                }
            };

            // DELETE GOAL
            const handleDelete = async (goalId) => {
                try {
                    const res = await fetch(GOAL_API_URL, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ goal_id: goalId }),
                    });

                    const result = await res.json();
                    if (result.status !== "success") throw new Error(result.message);

                    setGoals((prev) => prev.filter((g) => g.goal_id !== goalId));
                } catch (e) {
                    console.error(e);
                }
            };

            // EDIT GOAL
            const handleEdit = async (goalId, habitId, deadline, goalTime) => {
                try {
                    const res = await fetch(GOAL_API_URL, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            goal_id: goalId,
                            habit_id: habitId,
                            deadline,
                            goal_time: goalTime,
                        }),
                    });

                    const result = await res.json();
                    if (result.status !== "success") throw new Error(result.message);

                    setGoals((prev) =>
                        prev.map((g) =>
                            g.goal_id === goalId
                                ? { ...g, habit_id: habitId, deadline, goal_time: goalTime }
                                : g
                        )
                    );

                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            };

            return (
                <section className="goal-section">
                    <h2>Goals</h2>

                    {/* ADD GOAL */}
                    <form onSubmit={handleSubmit} className="poo-form">
                        <select
                            value={selectedHabit}
                            onChange={(e) => setSelectedHabit(e.target.value)}
                            className="poo-select"
                        >
                            <option value="">Select habit...</option>
                            {habits.map((h) => (
                                <option key={h.habit_id} value={h.habit_id}>
                                    {h.category}
                                </option>
                            ))}
                        </select>

                        <input
                            type="date"
                            value={deadline}
                            onChange={(e) => setDeadline(e.target.value)}
                            className="poo-input"
                        />

                        <input
                            type="number"
                            value={goalTime}
                            onChange={(e) => setGoalTime(e.target.value)}
                            className="poo-input"
                            placeholder="Hours"
                        />

                        <button className="add-button">Add Goal</button>
                    </form>

                    {/* LIST OF GOALS */}
                    {loading ? (
                        <div className="spinner"></div>
                    ) : (
                        <ul className="list">
                            {goals.map((g) => (
                                <GoalItem
                                    key={g.goal_id}
                                    goal={g}
                                    habits={habits}
                                    onDelete={handleDelete}
                                    onEdit={handleEdit}
                                />
                            ))}
                        </ul>
                    )}
                </section>
            );
        }

        // Friend item - same style as habit item but no edit button
        function FriendItem({ friend, onDelete }) {
            return (
                <li className="poo-item">
                    <span className="habit-text">{friend.username || friend.name || friend.display_name}</span>
                    <span className="list-actions">
                        <i
                            className="fa-solid fa-trash delete-icon"
                            onClick={() => onDelete(friend.friend_id)}
                        ></i>
                    </span>
                </li>
            );
        }

        // Friend manager - styled like habit-section, placed under right goal column
        function FriendManager({ friends, loading, setFriends }) {
            const [newFriend, setNewFriend] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newFriend.trim()) return;
                try {
                    const response = await fetch(FRIEND_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ friend_id: newFriend })
                    });
                    const result = await response.json();
                    if (!response.ok || result.status === 'error') throw new Error(result.message || 'Failed to add friend');

                    setNewFriend('');
                    setFriends(prev => [result.friend, ...prev]);
                } catch (e) {
                    console.error(e);
                }
            };

            const handleDelete = async (friendId) => {
                try {
                    const res = await fetch(FRIEND_API_URL, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ friend_id: friendId })
                    });
                    const result = await res.json();
                    if (result.status !== 'success') throw new Error(result.message);

                    setFriends(prev => prev.filter(f => f.friend_id !== friendId));
                } catch (e) {
                    console.error(e);
                }
            };

            return (
                <section className="habit-section"> {/* reuse habit-section styles for identical look */}
                    <h2>Friends</h2>
                    <form onSubmit={handleSubmit} className="poo-form">
                        <input
                            value={newFriend}
                            onChange={e => setNewFriend(e.target.value)}
                            placeholder="Add friend (user ID)"
                            className="poo-input"
                        />
                        <button type="submit" className="add-button">Add</button>
                    </form>

                    {loading ? <div className="spinner"></div> :
                        <ul className="list">
                            {friends.map(f => (
                                <FriendItem
                                    key={f.friend_id}
                                    friend={f}
                                    onDelete={handleDelete}
                                />
                            ))}
                        </ul>
                    }
                </section>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
