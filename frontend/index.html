<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoos Who Poop</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- API URLs ---
        // CHANGE B/W LOCAL AND UVA SERVER
        //const API_BASE_URL = 'http://localhost/HoosWhoPoop/backend/';
        const API_BASE_URL = 'https://www.cs.virginia.edu/~kng4jc/HoosWhoPoop/backend/';

        const HABIT_API_URL = `${API_BASE_URL}/habit-api.php`;
        const GOAL_API_URL = `${API_BASE_URL}/goal-api.php`;
        const CHECK_SESSION_API_URL = `${API_BASE_URL}/auth/check-session-api.php`;
        const LOGOUT_API_URL = `${API_BASE_URL}/auth/logout-api.php`;

        // --- Components ---
        const LoadingSpinner = () => <div className="spinner"></div>;

        const ErrorMessage = ({ message, onClear }) => (
            <div className="error-message">
                <strong>Error: </strong>
                <span>{message}</span>
                <span className="close" onClick={onClear}>âœ–</span>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [isCheckingAuth, setIsCheckingAuth] = useState(true);
            const [habits, setHabits] = useState([]);
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState({ habits: true, goals: true});
            const [error, setError] = useState(null);

            useEffect(() => {
                const checkAuth = async () => {
                    try {
                        const response = await fetch(CHECK_SESSION_API_URL, { credentials: 'include' });
                        if (!response.ok) throw new Error('Not logged in');
                        const data = await response.json();
                        if (data.status === 'success') setUser(data.user);
                        else throw new Error('Not logged in');
                    } catch (e) {
                        window.location.href = 'login.html';
                    } finally { setIsCheckingAuth(false); }
                };
                checkAuth();
            }, []);

            const fetchData = useCallback(async (url, key, setter) => {
                setLoading(prev => ({ ...prev, [key]: true }));
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                    const data = await response.json();
                    setter(data);
                } catch (e) {
                    setError(`Could not fetch ${key}: ${e.message}`);
                } finally {
                    setLoading(prev => ({ ...prev, [key]: false }));
                }
            }, []);

            useEffect(() => {
                if (user) {
                    fetchData(HABIT_API_URL, 'habits', setHabits);
                    fetchData(GOAL_API_URL, 'goals', setGoals);
                }
            }, [user, fetchData]);

            const handleLogout = async () => {
                try { await fetch(LOGOUT_API_URL, { method: 'POST', credentials: 'include' }); }
                finally { window.location.href = 'login.html'; }
            };

            if (isCheckingAuth) return <LoadingSpinner />;

            return (
                <div>
                    <NavBar user={user} handleLogout={handleLogout}/>

                    {error && <ErrorMessage message={error} onClear={() => setError(null)} />}
                    <div className="content-container">
                        <div className="main-columns">
                            <div className="three-columns">
                                <HabitManager habits={habits} loading={loading.habits} />
                            </div>
                            <div className="three-columns">
                                <GoalManager goals={goals} habits={habits} loading={loading.goals} />
                            </div>
                            <div className="three-columns">
                                <GoalManager goals={goals} habits={habits} loading={loading.goals} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function NavBar({user, handleLogout}) {
            return (
                <header className="app-header">
                    <h1>HoosWhoPoop</h1>
                    <p>Hello pooper, <span className="username">{user.username}</span></p>
                    <ul className="navigation">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="events.html">Entries</a></li>
                        <li><a href="rooms.html">Rooms</a></li>
                    </ul>
                    <button className="logout-button" onClick={handleLogout}>Logout</button>
                </header>
            )
        }

        function HabitManager({ habits, loading }) {
            const [newHabit, setNewHabit] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newHabit.trim()) return;
                try {
                    const response = await fetch(HABIT_API_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ category: newHabit })
                    });
                    const result = await response.json();
                    if (!response.ok || result.status === 'error') throw new Error(result.message || 'Failed to add habit');
                    setNewHabit('');
                    habits.unshift(result.habit);
                } catch (e) {
                    console.error(e);
                }
            };

            return (
                <section className="habit-section">
                    <h2>Habits</h2>
                    <form onSubmit={handleSubmit} className="habit-form">
                        <input value={newHabit} onChange={e=>setNewHabit(e.target.value)} placeholder="Add new habit" className="habit-input" />
                        <button type="submit" className="add-button">Add Habit</button>
                    </form>
                    {loading ? <LoadingSpinner /> :
                        <ul className="list">
                            {habits.map(h => (
                                <li key={h.habit_id} className="goal-item">
                                <span className="habit-text">
                                    {h.category}
                                </span>
                                <span className="list-actions">
                                    <i className="fa-solid fa-pen edit-icon"></i>
                                    <i className="fa-solid fa-trash delete-icon"></i>
                                </span>
                                </li>
                            ))}
                        </ul>
                    }
                </section>
            );
        }

        function GoalManager({ goals, habits, loading }) {
            const [selectedHabit, setSelectedHabit] = useState('');
            const [deadline, setDeadline] = useState('');
            const [goalTime, setGoalTime] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedHabit || !deadline || !goalTime) return;
                try {
                    const response = await fetch(GOAL_API_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ habit_id: parseInt(selectedHabit), deadline, goal_time: parseInt(goalTime) })
                    });
                    const result = await response.json();
                    if (!response.ok || result.status === 'error') throw new Error(result.message || 'Failed to add goal');
                    setSelectedHabit(''); setDeadline(''); setGoalTime('');
                    goals.unshift(result.goal);
                } catch (e) {
                    console.error(e);
                }
            };

            const handleDelete = async(goalID) => {
                /*TODO: use sql api to delete goal*/
            }

            const handleEdit = async(goalID) => {
                /*pop up form or use inline editing like in a todolist (code examples online you can use)*/
                /*TODO: use sql api to update goal*/
            }

            return (
                <section className="goal-section">
                    <h2>Goals</h2>
                    <form onSubmit={handleSubmit} className="goal-form">
                        <select value={selectedHabit} onChange={e=>setSelectedHabit(e.target.value)} className="goal-select">
                            <option value="">Select habit...</option>
                            {habits.map(h => <option key={h.habit_id} value={h.habit_id}>{h.category}</option>)}
                        </select>
                        <input type="date" value={deadline} onChange={e=>setDeadline(e.target.value)} className="goal-input" />
                        <input type="number" value={goalTime} onChange={e=>setGoalTime(e.target.value)} placeholder="Number of hours" className="goal-input" />
                        <button type="submit" className="add-button">Add Goal</button>
                    </form>
                    {loading ? <LoadingSpinner /> :
                        <ul className="list">
                            {goals.map(g => (
                                <li key={g.goal_id} className="goal-item">
                                <span className="goal-text">
                                    {g.category} - {g.goal_time} hrs by {g.deadline}
                                </span>
                                <span className="list-actions">
                                    <button className="icon-button edit-item" onClick={()=>handleEdit(g.goal_id)}> 
                                        <i className="fa-solid fa-pen edit-icon"></i>
                                    </button>
                                    <button className="icon-button delete-item" onClick={()=>handleDelete(g.goal_id)}> 
                                        <i className="fa-solid fa-trash delete-icon"></i>
                                    </button>
                                </span>
                                </li>
                            ))}
                        </ul>
                    }
                </section>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
